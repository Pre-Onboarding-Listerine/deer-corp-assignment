# 🛴 deer-corp-assignment 🛴

## 🛴 기업과제
- 기업명: 디어코퍼레이션
- 기업사이트: https://web.deering.co/
- 기업채용공고: https://www.wanted.co.kr/wd/59051

## 🛴 과제 내용

### **[필수 포함 사항]**

- READ.ME 작성
    - 프로젝트 빌드, 자세한 실행 방법 명시
    - 구현 방법과 이유에 대한 간략한 설명
    - 완료된 시스템이 배포된 서버의 주소
    - 해당 과제를 진행하면서 회고 내용 블로그 포스팅
- Swagger나 Postman을 이용하여 API 테스트 가능하도록 구현

### **[주요 평가 사항]**

- 주어진 정보를 기술적으로 설계하고 구현할 수 있는 역량
- 확장성을 고려한 시스템 설계 및 구현

### 과제 안내

디어는 사용자의 요금을 계산하기 위해 다양한 상황을 고려합니다. 

- 우선 지역별로 다양한 요금제를 적용하고 있습니다. 예를 들어 건대에서 이용하는 유저는 기본요금 790원에 분당요금 150원, 여수에서 이용하는 유저는 기본요금 300원에 분당요금 70원으로 적용됩니다.
- 할인 조건도 있습니다. 사용자가 파킹존에서 반납하는 경우 요금의 30%를 할인해주며, 사용자가 마지막 이용으로부터 30분 이내에 다시 이용하면 기본요금을 면제해줍니다.
- 벌금 조건도 있습니다. 사용자가 지역 바깥에 반납한 경우 얼마나 멀리 떨어져있는지 거리에 비례하는 벌금을 부과하며, 반납 금지로 지정된 구역에 반납하면 6,000원의 벌금을 요금에 추과로 부과합니다.
- 예외도 있는데, 킥보드가 고장나서 정상적인 이용을 못하는 경우의 유저들을 배려하여 1분 이내의 이용에는 요금을 청구하지 않고 있습니다.

- 최근에 다양한 할인과 벌금을 사용하여 지자체와 협력하는 경우가 점점 많아지고 있어 요금제에 새로운 할인/벌금 조건을 추가하는 일을 쉽게 만드려고 합니다. 어떻게 하면 앞으로 발생할 수 있는 다양한 할인과 벌금 조건을 기존의 요금제에 쉽게 추가할 수 있는 소프트웨어를 만들 수 있을까요? 

- 우선은 사용자의 이용에 관한 정보를 알려주면 현재의 요금 정책에 따라 요금을 계산해주는 API를 만들어주세요. 그 다음은, 기능을 유지한 채로 새로운 할인이나 벌금 조건이 쉽게 추가될 수 있게 코드를 개선하여 최종 코드를 만들어주세요.
----

## 🛴 팀: 리스테린(Listerine)

* 팀원

| 이름 | 역할 | GITHUB | BLOG |
| :---: | :---: | :---: | :---: |
| `김주완` | 개발 및 배포환경 설정, API 설계 및 구현 | [joowankim](https://github.com/joowankim) | https://make-easy-anything.tistory.com |
| `박은혜` | 애플리케이션 배포, 기능 구현 | [eunhye43](https://github.com/eunhye43) | https://velog.io/@majaeh43 |
| `윤수진` | API 구현 | [study-by-myself](https://github.com/study-by-myself)| https://pro-yomi.tistory.com |
| `주종민` | 모델 설계 및 구현 | [Gouache-studio](https://github.com/Gouache-studio) | https://gouache-studio.tistory.com/ |


## 🛴 구현 API

유저 정보를 가져오기 위해 유저 인증 및 회원가입을 구현하려 했으나 시간 부족으로 구현하지 못했습니다. 그래서 유저의 정보를 가져오기 위해 요금 계산 API는 `user_id`를 request body에 담아서 받습니다.

**HTTP Request**

```http request
POST /policies
content-type: "application/json"
```

**Request Body**

```json
{
    "user_id":1,
    "use_deer_name": 1,
    "use_end_lat": 37.455691,
    "use_ned_lng": 127.1351404,
    "use_start_at": "2021-11-18 10:00:00",
    "use_end_at": "2021-11-18 10:05:00"
}
```


### Unit test

테스트 코드는 `/tests` 디렉토리에서 확인하실 수 있습니다. 그리고 루트 디렉토리에서 다음 명령어로 테스트를 실행할 수 있습니다.

데이터베이스 컨테이너를 실행시킨 후에 테스트를 진행하시면 통합테스트 또한 통과하는 것을 확인할 수 있습니다.

```commandline
$ pytest
```

## 🛴 도메인 모델

유저의 Deer 이용 정보를 이용해 그에 대한 사용 요금을 계산하기 위해 다음과 같은 객체들을 생각해보았습니다.

- `FeeCalculator`: 존재하는 정책(`Policy`)을 이용해 유저의 Deer 사용 요금을 계산합니다.
- `Policy`: 정책에 정의된 조항(`Article`)을 이용해 이에 부합하는 지를 확인하고 유저의 사용 요금에 해당 정책을 적용해 계산합니다.
- `Article`: 유저의 Deer 이용정보 및 지역정보와 같은 데이터를 기반으로 해당 조항에 유저의 이용정보가 부합하는 지를 판단하고 조항에 따른 사용 요금을 계산합니다.

위와 같은 객체들을 기반으로 다음과 같은 규칙하에 사용 요금을 계산하였습니다.

1. 정책의 종류는 5가지로 다음과 같다.
    - 기본 요금 정책 (`BasicRatePolicy`): 지역별 기본 요금 데이터를 이용해 유저의 사용 요금을 책정합니다.
    - 비율 할인 정책 (`RateDiscountPolicy`): 부합하는 조항들 중에 할인율이 최대인 조항의 비율만큼의 요금을 사용 요금에서 차감시킵니다.
    - 정량 할인 정책 (`AmountDiscountPolicy`): 부합하는 조항들 중에 할인액이 최대인 조항의 제시된 요금만큼 사용 요금에서 차감시킵니다.
    - 벌금 정책 (`FinePolicy`): 부합하는 조항들 모두에서 제시된 벌금을 모두 합해 사용 요금에 추가시킵니다.
    - 예외 정책 (`ExceptionPolicy`): 부합하는 조항이 있다면 최종 사용 요금을 0원으로 책정합니다.
2. 사용 요금에 정책을 적용하는 순서는 다음과 같다.
    1. 기본 요금 정책
    2. 비율 할인 정책
    3. 정량 할인 정책
    4. 벌금 정책
    5. 예외 정책

각 정책에 대한 데이터는 다음과 같이 관리하였습니다.

- 기본 요금 정책: `area_fees` 테이블을 생성하고 지역별 기본 요금과 분당 요금을 저장해 필요할 때 가져다 쓸 수 있도록 설정했습니다.
- 할인 정책: `yamls/discounts.yaml` 파일을 이용해서 할인 정책에 대한 옵션들을 관리할 수 있도록 설정했습니다. 해당 파일의 정보는 `settings.py`로부터 `import`해 사용할 수 있습니다.
- 벌금 정책: `yamls/fines.yaml` 파일을 이용해서 벌금 정책에 대한 옵션들을 관리할 수 있도록 설정했습니다. 해당 파일의 정보는 `settings.py`로부터 `import`해 사용할 수 있습니다.
- 예외 정책: `yamls/expections.yaml` 파일을 이용해서 예외 정책에 대한 옵션들을 관리할 수 있도록 설정했습니다. 해당 파일의 정보는 `settings.py`로부터 `import`해 사용할 수 있습니다.

### 애플리케이션 구조

해당 애플리케이션은 요금 계산기, 정책, 조항이라는 모델들을 이용해 디자인 패턴 중 strategy pattern을 적용하려고 시도해보았습니다.

- `Article._is_applicable()`: 각 정책에 포함된 조항들은 오로지 사용자의 이용 정보가 해당 조항에 부합하는지만을 판단합니다.
- `Article.calculate()`: 사용자의 이용 정보가 정책의 조항에 부합한다면 해당 조항의 요금 계산법을 적용시켜 요금을 계산합니다.
- `Policy.apply_on()`: 정책은 자신이 가진 조항 중에 사용자의 이용 정보가 부합하는게 있다면 그 조항을 사용자의 사용 요금에 적용합니다.
- `FeeCalculator.calculate_with()`: 요금 계산기는 모든 정책을 알고있으며 정책이 사용 요금에 적용되는 순서를 결정합니다.

각 조항은 추상 클래스 `Article`을 상속받으며 `_is_applicable()`과 `calculate()` 메소드를 구현해 추가할 수 있습니다. 조항을 추가한 후에는 맞는 정책의 `articles`에 해당 조항을 추가해줍니다.

각 정책은 추상 클래스 `Policy`를 상속받으며 `apply_on()` 메소드를 구현해 추가할 수 있습니다. 정책을 추가한 후에는 `FeeCalculator.calculate_with()` 메소드에서 이를 생성해 정책 적용 순서에 포함시킬 수 있습니다.

## 🛴 실행환경 설절 방법

> `git`과 `docker`, `docker-compose`가 설치되어 있어야 합니다.

1. 레포지토리 git 클론

    ```bash
    $ git clone https://github.com/Pre-Onboarding-Listerine/deer-corp-assignment.git
    ```

2. 애플리케이션 실행하기

    ```bash
    $ docker-compose up

    # 애플리케이션을 백그라운드에서 실행하고 싶다면
    $ docker-compose up -d
    ```
    
3. 데이터 베이스 초기화
    
    ```bash
    # 데이터베이스 초기화
    $ docker-compose exec backend python init_db.py
    ```
    - 초기화된 데이터들에 대한 정보는 `init_db.py`에서 확인할 수 있습니다.

4. 애플리케이션에 접근하기

    ```
    http://localhost:8000
    ```

## 🛴 과제 결과물 테스트 및 확인 방법

1. POSTMAN 확인: https://documenter.getpostman.com/view/15905881/UVJWqfZk

2. 배포된 서버의 주소

    ```commandline
    3.37.127.222:8000
    ```

# 🛴 Reference

이 프로젝트는 원티드x위코드 백엔드 프리온보딩 과제 일환으로 디어코퍼레이션에서 출제한 과제를 기반으로 만들었습니다.
